<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Research Portal — GrandPi224</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.454.0/font/lucide.css">
<style>
  :root { --card: 255 255 255; --ink: 17 24 39; --muted: 107 114 128; --ring: 59 130 246; }
  .dark :root { --card: 24 24 27; --ink: 229 231 235; --muted: 156 163 175; --ring: 96 165 250; }
  .card { background-color: rgb(var(--card)); }
  .ink { color: rgb(var(--ink)); }
  .muted { color: rgb(var(--muted)); }
  .ring-focus:focus { outline: none; box-shadow: 0 0 0 3px rgba(var(--ring),.4); }
  .chev { transition: transform .15s ease; }
  details[open] .chev { transform: rotate(90deg); }
  .btn { @apply rounded-xl px-3 py-2 text-sm font-medium ring-focus border border-gray-200 dark:border-zinc-700 hover:bg-gray-50 dark:hover:bg-zinc-800; }
  .pill { @apply text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-zinc-800 text-gray-600 dark:text-gray-300; }
</style>
</head>

<body class="bg-gray-100 dark:bg-zinc-900 text-gray-900 dark:text-gray-100">

<header class="sticky top-0 z-50 backdrop-blur bg-white/70 dark:bg-zinc-900/70 border-b border-gray-200 dark:border-zinc-800">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
    <img src="logo.png" alt="Logo"
         class="h-12 w-12 object-contain rounded-lg bg-white p-1
                border border-gray-300 dark:border-zinc-700 shadow-sm" />
    <div>
      <h1 class="text-xl font-semibold ink">Research Portal</h1>
      <p class="text-xs muted">by GrandPi224</p>
    </div>
    <div class="flex-1"></div>
    <label class="relative w-full max-w-md">
      <i class="lucide-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      <input id="search" type="search" placeholder="Search sections, items, tags…" class="w-full pl-10 pr-3 py-2 rounded-xl border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 ring-focus" />
    </label>
    <button id="expandAll" class="btn ml-2" title="Expand/Collapse all">
      <span class="inline-flex items-center gap-2"><i class="lucide-panel-right-open"></i>Expand All</span>
    </button>
    <button id="themeToggle" class="btn" title="Light/Dark">
      <i class="lucide-sun dark:hidden"></i>
      <i class="lucide-moon hidden dark:inline"></i>
    </button>
  </div>
</header>

<main class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
  <section id="leftCol" class="space-y-4"></section>

  <section class="space-y-4">
    <div class="card rounded-2xl p-4 border border-gray-200 dark:border-zinc-800">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold ink">Quick Actions</h2>
      </div>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a class="btn flex items-center gap-2 justify-center" id="openAllLinks"><i class="lucide-external-link"></i>Open visible links</a>
        <a class="btn flex items-center gap-2 justify-center" href="#" id="downloadJSON"><i class="lucide-download"></i>Download JSON</a>
      </div>
      <p class="mt-3 text-sm muted">Search sweeps titles and tags. Examples: “UNRATE”, “yield curve”, “housing”.</p>
    </div>

    <div class="card rounded-2xl p-4 border border-gray-200 dark:border-zinc-800">
      <h2 class="text-lg font-semibold ink mb-2">Visible Items</h2>
      <ul id="flatList" class="space-y-2"></ul>
    </div>

    <div class="card rounded-2xl p-4 border border-gray-200 dark:border-zinc-800">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold ink">Data Editor</h2>
        <div class="flex gap-2">
          <button id="reloadShared" class="btn" title="Reload portal-data.json"><i class="lucide-refresh-cw"></i>Reload Shared</button>
          <button id="saveData" class="btn"><i class="lucide-save"></i>Save (local)</button>
        </div>
      </div>
      <p class="text-sm muted mt-1">Edits save to your browser only. Use <b>Download JSON</b> and commit <code>portal-data.json</code> to update the shared catalog.</p>
      <textarea id="dataEditor" class="mt-3 w-full h-64 rounded-xl border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 p-3 font-mono text-sm ring-focus"></textarea>
    </div>
  </section>
</main>

<footer class="max-w-7xl mx-auto px-4 pb-8">
  <p class="text-center text-xs muted">© <span id="year"></span> Research Portal.</p>
</footer>

<script>
const DEFAULT_DATA = { sections: [] };
let DATA = null;
let SOURCE = "default";

async function loadShared() {
  try {
    const res = await fetch("portal-data.json?ts=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("missing");
    const json = await res.json();
    DATA = json;
    SOURCE = "shared";
  } catch {
    const local = localStorage.getItem("portal-data");
    if (local) { DATA = JSON.parse(local); SOURCE = "local"; }
    else { DATA = DEFAULT_DATA; SOURCE = "default"; }
  }
}
loadShared().then(() => { refreshEditor(); render(); });

const leftCol = document.getElementById("leftCol");
const flatList = document.getElementById("flatList");

function el(tag, attrs={}, ...children){
  const n=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class") n.className=v;
    else if(k==="html") n.innerHTML=v;
    else n.setAttribute(k,v);
  });
  children.forEach(c=>n.append(c));
  return n;
}

function render(){
  leftCol.innerHTML="";
  flatList.innerHTML="";
  const query=document.getElementById("search").value.trim().toLowerCase();
  DATA.sections.forEach((section,si)=>{
    const card=el("div",{class:"card rounded-2xl border border-gray-200 dark:border-zinc-800 overflow-hidden"});
    const header=el("div",{class:"px-4 py-3 border-b border-gray-200 dark:border-zinc-800 flex items-center justify-between"});
    header.append(el("h2",{class:"text-xl font-semibold ink"},section.title));
    card.append(header);

    section.groups.forEach((group,gi)=>{
      const filtered=group.items.filter(it=>{
        if(!query) return true;
        const hay=(it.label+" "+(it.tags||[]).join(" ")+group.title+section.title).toLowerCase();
        return hay.includes(query);
      });
      if(filtered.length===0) return;
      const det=el("details",{class:"border-t border-gray-100 dark:border-zinc-800"});
      det.open = JSON.parse(localStorage.getItem(`open-${si}-${gi}`) || "false");
      det.addEventListener("toggle",()=>localStorage.setItem(`open-${si}-${gi}`, det.open));
      const sum=el("summary",{class:"cursor-pointer select-none px-4 py-3 hover:bg-gray-50 dark:hover:bg-zinc-800 flex items-center justify-between"});
      const left=el("div",{class:"flex items-center gap-2"});
      left.append(el("i",{class:"lucide-chevron-right chev text-gray-500"}));
      left.append(el("span",{class:"font-medium"},group.title));
      sum.append(left);
      sum.append(el("span",{class:"pill"},filtered.length+" item"+(filtered.length>1?"s":"")));
      det.append(sum);

      const list=el("ul",{class:"px-4 pb-3 space-y-2"});
      filtered.forEach(it=>{
        const li=el("li",{});
        const a=el("a",{href:it.url,target:"_blank",class:"block p-3 rounded-xl border border-gray-200 dark:border-zinc-800 hover:bg-gray-50 dark:hover:bg-zinc-800"});
        a.append(el("div",{class:"text-sm font-medium ink"},it.label));
        if(it.tags?.length){
          const row=el("div",{class:"mt-1 flex flex-wrap gap-1"});
          it.tags.forEach(t=>row.append(el("span",{class:"pill"},t)));
          a.append(row);
        }
        li.append(a);
        list.append(li);
        const flat=a.cloneNode(true);
        flat.className="block p-3 rounded-xl border border-gray-200 dark:border-zinc-800";
        flatList.append(el("li",{},flat));
      });
      det.append(list);
      card.append(det);
    });
    leftCol.append(card);
  });
}

document.getElementById("search").addEventListener("input",render);
document.getElementById("expandAll").addEventListener("click",()=>{
  const details=leftCol.querySelectorAll("details");
  const willOpen=Array.from(details).some(d=>!d.open);
  details.forEach(d=>d.open=willOpen);
});

const root=document.documentElement;
const storedTheme=localStorage.getItem("theme");
// Default to dark mode if no preference stored
if(!storedTheme || storedTheme==="dark"){ root.classList.add("dark"); localStorage.setItem("theme","dark"); }

document.getElementById("themeToggle").addEventListener("click",()=>{
  root.classList.toggle("dark");
  localStorage.setItem("theme", root.classList.contains("dark") ? "dark":"light");
});

const editor=document.getElementById("dataEditor");
function refreshEditor(){ if(!DATA) return; editor.value=JSON.stringify(DATA,null,2); }
document.getElementById("saveData").addEventListener("click",()=>{
  try{
    const parsed=JSON.parse(editor.value);
    DATA=parsed;
    localStorage.setItem("portal-data", JSON.stringify(DATA));
    render();
    alert("Saved locally. Use Download JSON to commit shared file.");
  } catch(e){ alert("Invalid JSON. Fix and try again."); }
});
document.getElementById("reloadShared").addEventListener("click",async()=>{
  localStorage.removeItem("portal-data");
  await loadShared();
  refreshEditor();
  render();
});
document.getElementById("downloadJSON").addEventListener("click",()=>{
  const blob=new Blob([JSON.stringify(JSON.parse(editor.value),null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="portal-data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
document.getElementById("openAllLinks").addEventListener("click",()=>{
  const links=leftCol.querySelectorAll('a[href^="http"]');
  const query=document.getElementById("search").value.trim().toLowerCase();
  let count=0;
  links.forEach(a=>{
    const text=a.textContent.toLowerCase()+" "+Array.from(a.parentElement.querySelectorAll(".pill")).map(x=>x.textContent).join(" ").toLowerCase();
    if(!query || text.includes(query)){ window.open(a.href,"_blank"); count++; }
  });
  if(count===0) alert("No visible links to open.");
});
document.getElementById("year").textContent=new Date().getFullYear();
</script>
</body>
</html>
